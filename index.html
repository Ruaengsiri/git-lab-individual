<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electricity Usage Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Thailand Electricity Data Dashboard</span>
    </div>
</nav>

<div class="container">
    <div class="row mb-4" id="kpi-row">
        <div class="col-md-4">
            <div class="card kpi-card p-3 mb-3">
                <h6 class="text-muted">Total Usage (kWh)</h6>
                <h3 id="total-usage">0</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card kpi-card p-3 mb-3">
                <h6 class="text-muted">Total Users</h6>
                <h3 id="total-users">0</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card kpi-card p-3 mb-3">
                <h6 class="text-muted">Top Province</h6>
                <h3 id="top-province">-</h3>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card p-3 mb-3">
                <h5>Top 10 Provinces by Usage (kWh)</h5>
                <div class="chart-container">
                    <canvas id="usageBarChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card p-3 mb-3">
                <h5>Usage by Category</h5>
                <div class="chart-container">
                    <canvas id="usagePieChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="table-container shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Detailed Data Breakdown</h5>
                    <input type="text" id="tableSearch" class="form-control w-25" placeholder="Search province...">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover" id="dataTable">
                        <thead class="table-light">
                            <tr>
                                <th>Province</th>
                                <th>Year</th>
                                <th>Total Usage (kWh)</th>
                                <th>Total Users</th>
                                <th>Avg Usage/User</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function loadDashboard() {
        try {
            // Fetch both JSON files
            const [usageRes, userRes] = await Promise.all([
                fetch('electricity_usages_en.json'),
                fetch('electricity_users_en.json')
            ]);

            const usageData = (await usageRes.json()).Sheet1; // Access Sheet1 wrapper
            const userData = await userRes.json(); // Direct array

            // Merge data by province and year
            const mergedData = usageData.map(usage => {
                const user = userData.find(u => u.province_name === usage.province_name && u.year === usage.year);
                
                // Calculate Totals
                const totalKwh = usage.residential_kwh + usage.small_business_kwh + usage.medium_business_kwh + usage.large_business_kwh;
                const totalCount = user ? (user.residential_count + user.small_business_count + user.medium_business_count + user.large_business_count) : 0;
                
                return { ...usage, totalKwh, totalCount };
            });

            updateKPIs(mergedData);
            renderCharts(mergedData);
            populateTable(mergedData);

        } catch (error) {
            console.error("Error loading data:", error);
            alert("Please ensure the JSON files are in the same folder and you are running this through a local server (e.g., Live Server in VS Code).");
        }
    }

    function updateKPIs(data) {
        const totalUsage = data.reduce((sum, item) => sum + item.totalKwh, 0);
        const totalUsers = data.reduce((sum, item) => sum + item.totalCount, 0);
        const topProvince = [...data].sort((a, b) => b.totalKwh - a.totalKwh)[0];

        document.getElementById('total-usage').innerText = totalUsage.toLocaleString();
        document.getElementById('total-users').innerText = totalUsers.toLocaleString();
        document.getElementById('top-province').innerText = topProvince.province_name;
    }

    function renderCharts(data) {
        // Bar Chart - Top 10 Provinces
        const top10 = [...data].sort((a, b) => b.totalKwh - a.totalKwh).slice(0, 10);
        new Chart(document.getElementById('usageBarChart'), {
            type: 'bar',
            data: {
                labels: top10.map(d => d.province_name),
                datasets: [{
                    label: 'Usage (kWh)',
                    data: top10.map(d => d.totalKwh),
                    backgroundColor: '#3498db'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // Pie Chart - Categories (using the first entry as an example of distribution)
        const categories = ['Residential', 'Small Biz', 'Med Biz', 'Large Biz'];
        const sample = data[0];
        new Chart(document.getElementById('usagePieChart'), {
            type: 'doughnut',
            data: {
                labels: categories,
                datasets: [{
                    data: [sample.residential_kwh, sample.small_business_kwh, sample.medium_business_kwh, sample.large_business_kwh],
                    backgroundColor: ['#f1c40f', '#e67e22', '#e74c3c', '#9b59b6']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function populateTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = data.map(d => `
            <tr>
                <td>${d.province_name}</td>
                <td>${d.year}</td>
                <td>${d.totalKwh.toLocaleString()}</td>
                <td>${d.totalCount.toLocaleString()}</td>
                <td>${(d.totalKwh / (d.totalCount || 1)).toFixed(2)}</td>
            </tr>
        `).join('');
    }

    // Search function
    document.getElementById('tableSearch').addEventListener('keyup', function() {
        const filter = this.value.toUpperCase();
        const rows = document.getElementById('tableBody').getElementsByTagName('tr');
        for (let row of rows) {
            const province = row.getElementsByTagName('td')[0].textContent;
            row.style.display = province.toUpperCase().includes(filter) ? "" : "none";
        }
    });

    loadDashboard();
</script>

</body>
</html>